<VirtualHost *:80>
    ServerName permanent.org
    Redirect permanent / https://www.permanent.org/
</VirtualHost>

<VirtualHost *:80>
    ServerName www.permanent.org
    ServerAlias *.permanent.org

    SetEnv AWS_ACCESS_KEY_ID "${AWS_ACCESS_KEY_ID}"
    SetEnv AWS_SECRET_ACCESS_KEY "${AWS_ACCESS_SECRET}"
    SetEnv AWS_DEFAULT_REGION "${AWS_REGION}"

    <IfModule mod_setenvif.c>
        SetEnvIf X-Forwarded-Proto "^https$" HTTPS
    </IfModule>

    <IfModule mod_rewrite.c>
        RewriteEngine On

        RewriteCond %{HTTP:X-Forwarded-Proto} !https
        RewriteRule ^.*$ https://www.permanent.org%{REQUEST_URI}

        RewriteCond %{HTTP_HOST} !^www\. [NC]
        RewriteRule ^(.*)$ https://www.permanent.org%{REQUEST_URI} [R=301,L]
    </IfModule>

    DirectoryIndex index.php

    <Directorymatch "^/.*/\.git+/">
        Order deny,allow
        Deny from all
    </Directorymatch>
    <Files ~ "^\.git">
        Order allow,deny
        Deny from all
    </Files>

    <FilesMatch "\.(sql|sh|env|yml)$">
        Order allow,deny
        Deny from all
    </FilesMatch>
    # Set some caching expiry values for performance reasons
    # Turn on Expires
    ExpiresActive On

    # Set up caching on media files for 1 week  (60 * 60 * 24 * 7 = 604800)
    <filesMatch ".([iI][cC][oO]|[gG][iI][fF]|[jJ][pP][gG]|[jJ][pP][eE][gG]|[pP][nN][gG]|[fF][lL][vV]|[pP][dD][fF]|[sS][wW][fF]|[mM][oO][vV]|[mM][pP]3|[wW][mM][vV]|[pP][pP][tT])$">
        ExpiresDefault A604800
        Header append Cache-Control "public"
    </filesMatch>

    # Set up caching on font files for 6 months (60 * 60 * 24 * 180 = 15724800)
    <filesMatch ".([eE][oO][tT]|[tT][tT][fF]|[sS][vV][gG]|[Ww][Oo][Ff][Ff]|[Ww][Oo][Ff][Ff]2)$">
        ExpiresDefault A15724800
        Header append Cache-Control "public"
    </filesMatch>

    <FilesMatch "\.(ttf|otf|eot|woff|woff2)$">
        <IfModule mod_headers.c>
            Header set Access-Control-Allow-Origin "*"
            Header set Cache-Control "max-age=3600"
            Header unset Pragma
        </IfModule>
    </FilesMatch>

    # Set up caching on html/css and js files for 3 hours for html and css as they can change frequently
    <filesMatch ".([[hH][tT][mM]|[hH][tT][mM][lL]|[cC][sS][sS]|[jJ][sS]|[jJ][sS][oO][nN])$">
       ExpiresDefault A10800
       Header append Cache-Control "public"
    </filesMatch>

    AliasMatch ^/api(.*) /data/www/api/index.php$1
    <Directory "/data/www/api">
        CGIPassAuth On
        Require all granted
        RewriteEngine On
        RewriteCond %{DOCUMENT_ROOT}/maintenance.html -f
        RewriteCond %{DOCUMENT_ROOT}/maintenance.enable -f
        RewriteCond %{SCRIPT_FILENAME} !maintenance.html
        RewriteRule ^.*$ /maintenance.html [R=503,L]
        ErrorDocument 503 /maintenance.html
        Header Set Cache-Control "max-age=0, no-store"
    </Directory>

    AliasMatch ^/preview(.*) /data/www/api/preview.php$1

    RewriteRule ^/m$ /app [L,R=302]
    RewriteRule ^/m/(.*)$ /app/$1 [L,R=302]
    Alias /app /data/www/mdot/dist/mdot
    Alias /gallery /data/www/mdot/dist/mdot
    Alias /p /data/www/mdot/dist/mdot
    Alias /share /data/www/mdot/dist/mdot
    Alias /.well-known /var/www/html/.well-known
    <Directory "/data/www/mdot/dist/mdot">
        Require all granted
        Options FollowSymLinks
        DirectoryIndex index.html
        RewriteEngine On
        RewriteCond %{DOCUMENT_ROOT}/maintenance.html -f
        RewriteCond %{DOCUMENT_ROOT}/maintenance.enable -f
        RewriteCond %{SCRIPT_FILENAME} !maintenance.html
        RewriteRule ^.*$ /maintenance.html [R=503,L]
        ErrorDocument 503 /maintenance.html
        Header Set Cache-Control "max-age=0, no-store"

        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} ^/(share|p)/ [NC]
        RewriteCond %{HTTP_USER_AGENT} "${CRAWLER_REGEX}" [NC]
        RewriteRule ^(.*)$ /preview/ [L,PT]

        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.html [L]
    </Directory>

    ErrorLog "/var/log/permanent/error.log"
    CustomLog "/var/log/permanent/access.log" vhost_combined

</VirtualHost>
